{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/Pascal%20Digny/Github%20Lab/Kabinda%20Lodge%202.0/src/app/api/pairing/generate/route.ts"],"sourcesContent":["/**\n * POST /api/pairing/generate\n * Generate a pairing token for agent registration\n */\nimport { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\n// Server-side Supabase client (use service role key in production)\nconst getServerSupabase = () => {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://xgcsmkapakcyqxzxpuqk.supabase.co';\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnY3Nta2FwYWtjeXF4enhwdXFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTQ3NTEsImV4cCI6MjA2NzkzMDc1MX0.N2ZaSfNJ-xOVQbevNIG7GejZPGmpImGRGIXP4uvumew';\n  \n  // Use service role key if available, otherwise fall back to anon key (with RLS)\n  const key = supabaseServiceKey || supabaseAnonKey;\n  \n  return createClient(supabaseUrl, key, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false\n    }\n  });\n};\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { agentName, hotelId } = body;\n\n    if (!agentName || !hotelId) {\n      return NextResponse.json(\n        { error: 'agentName and hotelId are required' },\n        { status: 400 }\n      );\n    }\n\n    // Get authenticated user from request headers\n    const authHeader = request.headers.get('authorization');\n    if (!authHeader) {\n      return NextResponse.json(\n        { error: 'Unauthorized' },\n        { status: 401 }\n      );\n    }\n\n    // Verify user has admin access to hotel\n    const authToken = authHeader.replace('Bearer ', '');\n    const serverSupabase = getServerSupabase();\n    \n    let user;\n    try {\n      const { data: userData, error: authError } = await serverSupabase.auth.getUser(authToken);\n      if (authError || !userData) {\n        return NextResponse.json(\n          { error: 'Unauthorized' },\n          { status: 401 }\n        );\n      }\n      user = userData;\n    } catch (authErr: any) {\n      console.error('Auth error:', authErr);\n      return NextResponse.json(\n        { error: 'Authentication failed' },\n        { status: 401 }\n      );\n    }\n\n    // Check if user is admin for this hotel\n    // Note: For single-hotel systems, we might skip this check or make it optional\n    // If hotel_users table doesn't exist or user isn't in it, allow if they're authenticated\n    try {\n      const { data: hotelUser, error: hotelUserError } = await serverSupabase\n        .from('hotel_users')\n        .select('role')\n        .eq('hotel_id', hotelId)\n        .eq('user_id', user.id)\n        .maybeSingle();\n\n      // If hotel_users table exists and user is in it, check role\n      if (hotelUser && !hotelUserError && hotelUser.role !== 'admin') {\n        return NextResponse.json(\n          { error: 'Forbidden: Admin access required' },\n          { status: 403 }\n        );\n      }\n      // If hotel_users doesn't exist or user not in it, allow if authenticated (for single-hotel systems)\n    } catch (checkError: any) {\n      // If hotel_users table doesn't exist, allow authenticated users (for development)\n      console.warn('Could not check hotel_users, allowing authenticated user:', checkError);\n    }\n\n    // Generate pairing token (short-lived, 5 minutes)\n    const pairingTokenValue = crypto.randomUUID();\n    const expiresAt = new Date();\n    expiresAt.setMinutes(expiresAt.getMinutes() + 5);\n\n    // For inserting pairing tokens, use service role key if available to bypass RLS\n    // Otherwise, create a client with the user's JWT token so RLS can identify the user\n    const hasServiceKey = !!process.env.SUPABASE_SERVICE_ROLE_KEY;\n    console.log('Creating pairing token - Service key available:', hasServiceKey);\n    \n    const insertClient = hasServiceKey\n      ? createClient(\n          process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://xgcsmkapakcyqxzxpuqk.supabase.co',\n          process.env.SUPABASE_SERVICE_ROLE_KEY!,\n          {\n            auth: {\n              autoRefreshToken: false,\n              persistSession: false\n            }\n          }\n        )\n      : createClient(\n          process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://xgcsmkapakcyqxzxpuqk.supabase.co',\n          process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnY3Nta2FwYWtjeXF4enhwdXFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTQ3NTEsImV4cCI6MjA2NzkzMDc1MX0.N2ZaSfNJ-xOVQbevNIG7GejZPGmpImGRGIXP4uvumew',\n          {\n            global: {\n              headers: {\n                Authorization: `Bearer ${authToken}`\n              }\n            },\n            auth: {\n              autoRefreshToken: false,\n              persistSession: false\n            }\n          }\n        );\n\n    // Store pairing token\n    const { data: pairingToken, error: tokenError } = await insertClient\n      .from('pairing_tokens')\n      .insert({\n        hotel_id: hotelId,\n        token: pairingTokenValue,\n        agent_name: agentName,\n        created_by: user.id,\n        expires_at: expiresAt.toISOString(),\n      })\n      .select()\n      .single();\n\n    if (tokenError) {\n      console.error('Error creating pairing token:', {\n        error: tokenError,\n        message: tokenError.message,\n        code: tokenError.code,\n        details: tokenError.details,\n        hint: tokenError.hint,\n        hasServiceKey,\n        userId: user.id,\n        hotelId\n      });\n      \n      // If RLS blocks the insert, provide a more helpful error message\n      if (tokenError.message?.includes('row-level security') || \n          tokenError.message?.includes('permission denied') ||\n          tokenError.code === '42501') {\n        return NextResponse.json(\n          { \n            error: 'Permission denied: Unable to create pairing token. Please ensure RLS policies allow authenticated users to create pairing tokens.',\n            details: tokenError.message,\n            hint: hasServiceKey \n              ? 'Service key is set but RLS is still blocking. Check that the policy was updated correctly.'\n              : 'Service key is not set. Either set SUPABASE_SERVICE_ROLE_KEY or update RLS policies.'\n          },\n          { status: 403 }\n        );\n      }\n      return NextResponse.json(\n        { error: `Failed to create pairing token: ${tokenError.message}`, details: tokenError },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({\n      pairingToken: pairingTokenValue,\n      expiresAt: expiresAt.toISOString(),\n    });\n  } catch (error: any) {\n    console.error('Error in pairing/generate:', error);\n    return NextResponse.json(\n      { error: error.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}