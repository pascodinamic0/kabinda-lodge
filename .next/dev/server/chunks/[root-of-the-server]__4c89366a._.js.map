{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/Pascal%20Digny/Github%20Lab/Kabinda%20Lodge%202.0/src/app/api/agents/route.ts"],"sourcesContent":["/**\n * Agents API Routes\n * GET /api/agents - List agents\n */\nimport { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nconst getServerSupabase = () => {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://xgcsmkapakcyqxzxpuqk.supabase.co';\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnY3Nta2FwYWtjeXF4enhwdXFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTQ3NTEsImV4cCI6MjA2NzkzMDc1MX0.N2ZaSfNJ-xOVQbevNIG7GejZPGmpImGRGIXP4uvumew';\n  \n  // Use service role key if available, otherwise fall back to anon key (with RLS)\n  const key = supabaseServiceKey || supabaseAnonKey;\n  \n  return createClient(supabaseUrl, key, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false\n    }\n  });\n};\n\n// GET /api/agents\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const hotelId = searchParams.get('hotel');\n    const status = searchParams.get('status');\n\n    if (!hotelId) {\n      return NextResponse.json(\n        { error: 'hotel parameter is required' },\n        { status: 400 }\n      );\n    }\n\n    const serverSupabase = getServerSupabase();\n    \n    // If no agents table exists yet, return empty array\n    try {\n\n      let query = serverSupabase\n        .from('agents')\n        .select('*')\n        .eq('hotel_id', hotelId)\n        .order('last_seen', { ascending: false });\n\n      if (status) {\n        query = query.eq('status', status);\n      }\n\n      const { data: agents, error } = await query;\n\n      if (error) {\n        console.error('Error fetching agents:', error);\n        // If RLS blocks access, return empty array instead of error (for development)\n        if (error.message?.includes('row-level security') || error.message?.includes('permission denied') || error.message?.includes('relation') || error.code === 'PGRST116') {\n          console.warn('RLS blocked agents query or table does not exist, returning empty array');\n          return NextResponse.json({ agents: [] });\n        }\n        return NextResponse.json(\n          { error: `Failed to fetch agents: ${error.message}` },\n          { status: 500 }\n        );\n      }\n\n      // Get queue length for each agent (pending card issues)\n      // Handle errors gracefully - if card_issues table doesn't exist or query fails, just return agents without queue length\n      const agentsWithQueue = await Promise.all(\n        (agents || []).map(async (agent) => {\n          try {\n            const { count } = await serverSupabase\n              .from('card_issues')\n              .select('*', { count: 'exact', head: true })\n              .eq('agent_id', agent.id)\n              .in('status', ['pending', 'queued']);\n\n            return {\n              ...agent,\n              queueLength: count || 0,\n            };\n          } catch (queueError: any) {\n            // If queue query fails, just return agent without queue length\n            console.warn('Could not get queue length for agent:', agent.id, queueError);\n            return {\n              ...agent,\n              queueLength: 0,\n            };\n          }\n        })\n      );\n\n      return NextResponse.json({ agents: agentsWithQueue });\n    } catch (tableError: any) {\n      // If agents table doesn't exist, return empty array\n      console.warn('Agents table may not exist or query failed:', tableError);\n      return NextResponse.json({ agents: [] });\n    }\n  } catch (error: any) {\n    console.error('Error in GET /api/agents:', error);\n    return NextResponse.json(\n      { error: error.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;AACD;AACA;;;AAEA,MAAM,oBAAoB;IACxB,MAAM,cAAc,QAAQ,GAAG,CAAC,wBAAwB,IAAI;IAC5D,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAChE,MAAM,kBAAkB,QAAQ,GAAG,CAAC,6BAA6B,IAAI;IAErE,gFAAgF;IAChF,MAAM,MAAM,sBAAsB;IAElC,OAAO,IAAA,yMAAY,EAAC,aAAa,KAAK;QACpC,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF;AAGO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,UAAU,aAAa,GAAG,CAAC;QACjC,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA8B,GACvC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,iBAAiB;QAEvB,oDAAoD;QACpD,IAAI;YAEF,IAAI,QAAQ,eACT,IAAI,CAAC,UACL,MAAM,CAAC,KACP,EAAE,CAAC,YAAY,SACf,KAAK,CAAC,aAAa;gBAAE,WAAW;YAAM;YAEzC,IAAI,QAAQ;gBACV,QAAQ,MAAM,EAAE,CAAC,UAAU;YAC7B;YAEA,MAAM,EAAE,MAAM,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM;YAEtC,IAAI,OAAO;gBACT,QAAQ,KAAK,CAAC,0BAA0B;gBACxC,8EAA8E;gBAC9E,IAAI,MAAM,OAAO,EAAE,SAAS,yBAAyB,MAAM,OAAO,EAAE,SAAS,wBAAwB,MAAM,OAAO,EAAE,SAAS,eAAe,MAAM,IAAI,KAAK,YAAY;oBACrK,QAAQ,IAAI,CAAC;oBACb,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,QAAQ,EAAE;oBAAC;gBACxC;gBACA,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO,CAAC,wBAAwB,EAAE,MAAM,OAAO,EAAE;gBAAC,GACpD;oBAAE,QAAQ;gBAAI;YAElB;YAEA,wDAAwD;YACxD,wHAAwH;YACxH,MAAM,kBAAkB,MAAM,QAAQ,GAAG,CACvC,CAAC,UAAU,EAAE,EAAE,GAAG,CAAC,OAAO;gBACxB,IAAI;oBACF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,eACrB,IAAI,CAAC,eACL,MAAM,CAAC,KAAK;wBAAE,OAAO;wBAAS,MAAM;oBAAK,GACzC,EAAE,CAAC,YAAY,MAAM,EAAE,EACvB,EAAE,CAAC,UAAU;wBAAC;wBAAW;qBAAS;oBAErC,OAAO;wBACL,GAAG,KAAK;wBACR,aAAa,SAAS;oBACxB;gBACF,EAAE,OAAO,YAAiB;oBACxB,+DAA+D;oBAC/D,QAAQ,IAAI,CAAC,yCAAyC,MAAM,EAAE,EAAE;oBAChE,OAAO;wBACL,GAAG,KAAK;wBACR,aAAa;oBACf;gBACF;YACF;YAGF,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ;YAAgB;QACrD,EAAE,OAAO,YAAiB;YACxB,oDAAoD;YACpD,QAAQ,IAAI,CAAC,+CAA+C;YAC5D,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ,EAAE;YAAC;QACxC;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,MAAM,OAAO,IAAI;QAAwB,GAClD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}